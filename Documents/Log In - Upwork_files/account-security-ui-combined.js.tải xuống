(function(angular){"use strict";var module=angular.module("account-security-ui.constants",["components.core.psmetrics"]);var trafficRate=Applet.getVar("account_security_ui_psmetrics_traffic_rate");if("undefined"!==typeof trafficRate){module.constant("PSMETRICS_TRAFFIC_RATE",parseFloat(trafficRate))}module.constant("MODE_REENTER_PASSWORD","reenter-password").constant("MODE_DEVICE_AUTHORIZATION","device-auth")})(angular);
(function(angular){"use strict";angular.module("account-security-ui",["components.core","components.core.alert","components.core.validation","account-security-ui.constants","account-security-ui.directives","account-security-ui.controllers","account-security-ui.interceptors","account-security-ui.factories"])})(angular);
(function(angular){"use strict";angular.module("account-security-ui.controllers",[]).controller("loginCtrl",["$scope","$timeout","$document",function($scope,$timeout,$document){var usernameInput=$document[0].getElementById("login_username"),passwordInput=$document[0].getElementById("login_password"),lastUsernameInput=$document[0].getElementById("login_username_last"),loginForm;$scope.password=passwordInput.value;$scope.username=usernameInput.value;$timeout(function(){var userNameAfterError=lastUsernameInput.getAttribute("data-value");if(usernameInput.value||passwordInput.value){$scope.login["login[password]"].$setValidity("required");$scope.login["login[username]"].$setValidity("required")}if(userNameAfterError){$scope.username=userNameAfterError}},500);$scope.submit=function($event){$event.preventDefault();revalidateForm();if($scope.login.$valid){$scope.login.$setSubmitted();getForm().submit()}};$scope.isSubmitDisabled=function(){return $scope.login.$submitted};function revalidateForm(){var inputs=getForm().querySelectorAll('input[type="text"], input[type="password"]'),ctrl;for(var i=0,l=inputs.length;i<l;i++){ctrl=$scope.login[inputs[i].name];if(ctrl){ctrl.$setDirty();ctrl.$validate()}}}function getForm(){if(!loginForm){loginForm=$document[0].querySelector('form[name="login"]')}return loginForm}}])})(angular);
(function(angular){"use strict";angular.module("account-security-ui.directives",[])})(angular);
(function(angular){"use strict";angular.module("account-security-ui.directives").directive("authModel",["$parse","$compile",function($parse,$compile){return{restrict:"A",link:function($scope,element,attrs){if(attrs.ngModel||"undefined"===typeof attrs.name){return}var modelKey="data['"+attrs.name+"']";element[0].setAttribute("ng-model",modelKey);if("undefined"!==typeof attrs.value){$parse(modelKey).assign($scope,attrs.value)}if(attrs.authModel){if("undefined"===typeof $scope.aliases){$scope.aliases={}}$scope.aliases[attrs.authModel]=attrs.name}if(attrs.clearOnError){if("undefined"===typeof $scope.clearOnErrorInputs){$scope.clearOnErrorInputs=[]}$scope.clearOnErrorInputs.push(attrs.name)}$compile(element)($scope)}}}])})(angular);
(function(angular){"use strict";angular.module("account-security-ui.directives").directive("authSzLink",["sensitiveZone",function(sensitiveZone){return{restrict:"A",link:function($scope,element,attrs){element[0].onclick=function(event){if(event){event.preventDefault&&event.preventDefault();event.stopPropagation&&event.stopPropagation()}sensitiveZone.navigate(attrs.href,attrs.code);return false}}}}])})(angular);
(function(angular){"use strict";angular.module("account-security-ui.directives").directive("deviceAuthForm",["baseAuthForm","$document","$window",function(baseAuthForm,$document,$window){return{scope:{mode:"@",onload:"&"},restrict:"E",link:function($scope,element){var fieldRememberStorageKey="deviceAuth.remember",fieldRememberStoredValue=$window.localStorage.getItem(fieldRememberStorageKey),submitted=false;baseAuthForm.init($scope,"deviceAuth");baseAuthForm.loadTemplate($scope,element,"device-authorization.html",function(){$scope.data[$scope.aliases.remember]=fieldRememberStoredValue!=="false"});$scope.submit=function($event){$event.preventDefault();$event.stopPropagation();$window.localStorage.setItem(fieldRememberStorageKey,$scope.data[$scope.aliases.remember]);var actionUrl=$document[0].forms.deviceAuth.action;baseAuthForm.submit($scope,actionUrl,$scope.data,function(response){var responseData=response.data;if(responseData.reverifyData&&responseData.reverifyUrl){baseAuthForm.submit($scope,responseData.reverifyUrl,responseData.reverifyData)}else{baseAuthForm.showUndefinedError($scope)}})}}}}])})(angular);
(function(angular){"use strict";angular.module("account-security-ui.directives").directive("reenterPasswordForm",["baseAuthForm","$document",function(baseAuthForm,$document){return{scope:{mode:"@",onload:"&"},restrict:"E",link:function($scope,element){baseAuthForm.init($scope,"sensitiveZone");baseAuthForm.loadTemplate($scope,element,"reenter-password.html");$scope.submit=function($event){$event.preventDefault();$event.stopPropagation();var actionUrl=$document[0].forms.sensitiveZone.action;baseAuthForm.submit($scope,actionUrl,$scope.data)}}}}])})(angular);
(function(angular){"use strict";angular.module("account-security-ui.interceptors",[])})(angular);
(function(angular){"use strict";angular.module("account-security-ui.interceptors").config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push("sensitiveZoneInterceptor")}]).factory("sensitiveZoneInterceptor",["$q","$injector","sensitiveZone","MODE_REENTER_PASSWORD","MODE_DEVICE_AUTHORIZATION",function($q,$injector,sensitiveZone,MODE_REENTER_PASSWORD,MODE_DEVICE_AUTHORIZATION){var responseQueue={},modalInstance=null;return{response:function(response){var mode=getSensitiveZoneMode(response);if(mode){if(modalInstance){modalInstance.close();modalInstance=null;sensitiveZone.setModalShown(false)}while(rerunRequestOnQueue(mode));}return $q.resolve(response)},responseError:function(response){if(401!==response.status){return $q.reject(response)}var mode=getSensitiveZoneMode(response);if(!mode){return $q.reject(response)}var data=response.data;if(data.redirectUrl){sensitiveZone.navigate(data.redirectUrl,data.redirectCode);return $q.reject(response)}var deferred=$q.defer();addResponseToQueue(mode,response,deferred);showModal(mode);return deferred.promise}};function showModal(mode){if(modalInstance){return}var eoModal=$injector.get("eoModal");modalInstance=eoModal.custom({locals:{},backdrop:"static",keyboard:false,template:getTemplate(mode)});sensitiveZone.setModalShown(true)}function rerunRequestOnQueue(mode){var modeQueue=responseQueue[mode],item=modeQueue.pop();if(item){rerunRequest(item)}return modeQueue.length}function rerunRequest(item){var $http=$injector.get("$http");$http(item.response.config).then(function(response){item.deferred.resolve(response)},function(response){item.deferred.reject(response)})}function getTemplate(mode){var tag;switch(mode){case MODE_REENTER_PASSWORD:tag="reenter-password-form";break;case MODE_DEVICE_AUTHORIZATION:tag="device-auth-form";break;default:throw new Error("Undefined Sensitive Zone mode: "+mode)}return'<div data-eo-block="{{!_szModalReady}}" ng-hide="_szModalReady" class="m-xlg-top-bottom">&nbsp;</div>'+"<"+tag+' mode="modal" onload="_szModalReady=true"></'+tag+">"}function addResponseToQueue(mode,response,deferred){if(!responseQueue[mode]){responseQueue[mode]=[]}responseQueue[mode].push({response:response,deferred:deferred})}function getSensitiveZoneMode(response){if(!response.data){return null}var mode=response.data.szMode;switch(mode){case MODE_REENTER_PASSWORD:case MODE_DEVICE_AUTHORIZATION:return mode}return null}}])})(angular);
(function(angular){"use strict";angular.module("account-security-ui.factories",[])})(angular);
(function(angular){"use strict";angular.module("account-security-ui.factories").factory("baseAuthForm",["$compile","$window","$document","$http","$timeout","sensitiveZone",function($compile,$window,$document,$http,$timeout,sensitiveZone){var submitted=false;return{init:init,loadTemplate:loadTemplate,submit:submit,prepareUrl:prepareUrl};function init($scope,formName){$scope.logout=function($event){$event.preventDefault();$event.stopPropagation();$document[0].forms.logoutUser.submit()};$scope.isSubmitDisabled=function(){return $scope[formName].$invalid||submitted}}function submit($scope,url,data,callback){$scope.undefinedError=false;$scope.errorMessage="";submitted=true;$http.post(prepareUrl($scope,url),data).then(function(response){if(!response.data){showUndefinedError($scope);return}var responseData=response.data;if(responseData.redirectUrl){sensitiveZone.navigate(responseData.redirectUrl,responseData.redirectCode);submitted=false;return}if(responseData.error){showError($scope,responseData.error);return}submitted=false;if(callback){callback(response)}},function(){showUndefinedError($scope)})}function showError($scope,errorMessage){$scope.errorMessage=errorMessage;if(errorMessage){submitted=false;clearInputsOnError($scope)}}function showUndefinedError($scope){submitted=false;$scope.undefinedError=true;$scope.errorMessage="";clearInputsOnError($scope)}function clearInputsOnError($scope){for(var i=0,l=$scope.clearOnErrorInputs.length;i<l;i++){$scope.data[$scope.clearOnErrorInputs[i]]=""}}function loadTemplate($scope,element,formName,callback){var url=getUrl($scope,formName),templateNode=$document[0].getElementById(formName);if(templateNode){setTemplate(templateNode.innerHTML);return}$http.get(url).then(function(response){setTemplate(response.data);rePosition()});function setTemplate(templateString){element.append($compile(templateString)($scope));if($scope.onload){$scope.onload()}if(callback){callback()}}}function rePosition(){$timeout(function(){angular.element($window).triggerHandler("resize")})}function getUrl($scope,path){var url=Applet.getVar("account_security_base_url")+"/"+path;return prepareUrl($scope,url)}function prepareUrl($scope,url){if("modal"===$scope.mode){url+="?mode=modal"}return url}}])})(angular);
(function(angular){"use strict";angular.module("account-security-ui.factories").factory("sensitiveZone",["$document","$timeout",function($document,$timeout){var changeCallback=null,modalShown=false;return{onLocationChange:onLocationChange,navigate:navigate,isModalShown:isModalShown,setModalShown:setModalShown};function onLocationChange(callback){changeCallback=callback}function navigate(url,code){if("logout"!==code&&changeCallback){$timeout(function(){changeCallback(url,code)})}else{$document[0].location=url}}function isModalShown(){return modalShown}function setModalShown(shown){$timeout(function(){modalShown=shown})}}])})(angular);